name: Android Build v23 - Fixed Icon

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Install Android NDK
      run: |
        echo "Installing Android NDK..."
        sdkmanager --install "ndk;26.1.10909125"
        echo "NDK installed successfully!"

    - name: Install dependencies
      run: npm ci

    - name: Update version to 23
      run: |
        echo "Updating version to 22 (1.0.11)..."

        # Update package.json
        sed -i 's/"version": ".*"/"version": "1.0.11"/' package.json

        # Update build.gradle versionCode and versionName
        sed -i 's/versionCode [0-9]*/versionCode 23/' android/app/build.gradle
        sed -i 's/versionName ".*"/versionName "1.0.11"/' android/app/build.gradle
        sed -i 's/versionCodeOverride = [0-9]*/versionCodeOverride = 23/' android/app/build.gradle

        echo "Version updated successfully!"

    - name: Generate app icons from resources/icon.png
      run: |
        echo "Generating Android icons from resources/icon.png..."
        npm install -g @capacitor/assets
        npx @capacitor/assets generate --android
        echo "Icons generated successfully!"

    - name: Build optimized React app
      run: npm run build
      env:
        NODE_OPTIONS: --max-old-space-size=4096

    - name: Sync Capacitor
      run: npx cap sync android

    - name: Verify icons were generated
      run: |
        echo "Checking if icons were generated..."
        ls -lh android/app/src/main/res/mipmap-hdpi/ic_launcher.png
        ls -lh android/app/src/main/res/mipmap-xhdpi/ic_launcher.png
        ls -lh android/app/src/main/res/mipmap-xxhdpi/ic_launcher.png

    - name: Verify AdMob configuration
      run: |
        echo "Checking AdMob Application ID in AndroidManifest.xml..."
        grep "ca-app-pub-3375938019790298~8473700666" android/app/src/main/AndroidManifest.xml || echo "WARNING: AdMob ID not found!"

    - name: Make gradlew executable
      run: chmod +x android/gradlew

    - name: Decode keystore
      env:
        KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
      run: |
        echo "Decoding keystore..."
        echo "$KEYSTORE_BASE64" | base64 -d > android/app/release.keystore
        echo "Keystore decoded successfully!"

    - name: Build Android Release AAB
      env:
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      run: |
        cd android

        echo "Building release AAB with custom icon..."

        # Set Gradle options for better performance
        export GRADLE_OPTS="-Xmx4096m -XX:MaxMetaspaceSize=512m"

        ./gradlew bundleRelease \
          -Pandroid.injected.signing.store.file=$(pwd)/app/release.keystore \
          -Pandroid.injected.signing.store.password=$KEYSTORE_PASSWORD \
          -Pandroid.injected.signing.key.alias=$KEY_ALIAS \
          -Pandroid.injected.signing.key.password=$KEY_PASSWORD \
          --stacktrace

    - name: Verify AAB was created
      run: |
        if [ -f "android/app/build/outputs/bundle/release/app-release.aab" ]; then
          echo "✅ AAB created successfully with custom icon!"
          ls -lh android/app/build/outputs/bundle/release/app-release.aab
        else
          echo "❌ AAB not found!"
          exit 1
        fi

    - name: Upload AAB artifact
      uses: actions/upload-artifact@v4
      with:
        name: cosmic-astrology-v23-custom-icon
        path: android/app/build/outputs/bundle/release/app-release.aab
        retention-days: 30
        if-no-files-found: error

    - name: Build summary
      run: |
        echo "## 🚀 Build Complete - Version 23 (1.0.11)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 📦 Build Artifacts:" >> $GITHUB_STEP_SUMMARY
        echo "- **AAB File**: app-release.aab" >> $GITHUB_STEP_SUMMARY
        echo "- **Size**: $(ls -lh android/app/build/outputs/bundle/release/app-release.aab | awk '{print $5}')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ✨ Changes in v23:" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Custom app icon generated from resources/icon.png" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Android NDK 26.1 installed" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ MultiDex enabled for large bundle" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ largeHeap enabled for RAM optimization" >> $GITHUB_STEP_SUMMARY
